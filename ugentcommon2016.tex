%%----------------------------------------------------------------------------------------------------------------------
%% Copyright (C) 2019 by Niko Strijbol
%%
%% This file may be distributed and/or modified under the conditions of the LaTeX Project Public License, either version
%% 1.3c of this license or (at your option) any later version. The latest version of this license is in:
%%
%%      http://www.latex-project.org/lppl.txt
%%
%% and version 1.3c or later is part of all distributions of LaTeX version 2006/05/20 or later.
%%----------------------------------------------------------------------------------------------------------------------
%%
%% ugentcommon2016.tex
%%
%% Common code for the document classes. At the moment, this code is used as \input{ugentcommon2016} in those classes.
%% However, in the future, we might move to dtx.

% These packages need to be loaded after the class and options to prevent issues.
\RequirePackage{etoolbox}
\RequirePackage{ugentstyle2016}

\AtEndPreamble{
    \RequirePackage{xstring}
    \RequirePackage[normalem]{ulem}
    \RequirePackage{scrlayer-scrpage}
    \RequirePackage{tikz}
    \RequirePackage{graphicx}
    \RequirePackage{textcase}
    \RequirePackage{hyperref}

    \newcommand*{\@showfooter}{0}

    \ifugentcls@footer
        \gdef\@showfooter{1}
    \else
        \IfStrEq{\ugentcls@ugentstyle}{notes}{
            \gdef\@showfooter{1}
        }{
            \gdef\@showfooter{0}
        }
    \fi
}

\AtBeginDocument{

    % Applied when the user wants the margins to be set, but nothing else.
    \IfStringInList{\ugentcls@layout}{margins,colours,titlestyle,titlefont,all}{
        \IfEq{\@showfooter}{1}{
            \newgeometry{margin=2\smallblock,bottom=2.3\smallblock}
        }{
            \newgeometry{margin=2\smallblock,bottom=2\smallblock,foot=1.2\smallblock}
        }
    }{}

    % This block is applied when the user wants full UGent style.
    % It sets the main font to Arial; we don't use Panno, since the UGent doesn't
    % have a license for italic versions.
    \IfStrEq{\ugentcls@layout}{all}{
        \setmainfont{Arial}
    }{}

    % Applied when the user wants the titles in the correct colours, but nothing else.
    \IfStringInList{\ugentcls@layout}{colours,titlestyle,titlefont,all}{
        \addtokomafont{disposition}{\color{ugent-blue}}
    }{}

    \IfStringInList{\ugentcls@layout}{titlestyle,titlefont,all}{
        \renewcommand\partlineswithprefixformat[3]{#2{\MakeUppercase{#3}}}
        \renewcommand{\ULthickness}{0.7mm}
        \renewcommand{\ULdepth}{1.6mm}
        \ifcsundef{chapter}{}{
            \addtokomafont{chapter}{\selectfont\bfseries}
            \renewcommand\chapterlineswithprefixformat[3]{#2{\MakeUppercase{\uline{#3}}}}
            \renewcommand{\chapterlinesformat}[3]{\@hangfrom{#2}{\uline{\MakeUppercase{#3}}}}
        }
        \addtokomafont{section}{\bfseries}
        \addtokomafont{subsection}{\bfseries}
        \addtokomafont{subsubsection}{\bfseries}
    }{}

    % This block is applied when the user wants the titles in UGent style, but not the main text.
    % Format the titles according to the UGent style (fonts and text decorations)
    % Sizes are not set, allowing for more flexibility for the user.
    \IfStringInList{\ugentcls@layout}{titlefont,all}{
        \addtokomafont{disposition}{\pannofamily}
        \renewcommand{\ULthickness}{0.5mm}
        \renewcommand{\ULdepth}{1.25mm}
        \newcommand*\tocentryformat[1]{{\pannofamily#1}}
        \RedeclareSectionCommands[tocentryformat=\tocentryformat, tocpagenumberformat=\tocentryformat]
            {section,subsection,subsubsection,paragraph,subparagraph}
    }{}

    \NewTranslationFallback{title}{Titel}
    \NewTranslation{english}{title}{Title}
    \NewTranslationFallback{date}{Datum}
    \NewTranslation{english}{date}{Date}
    \NewTranslationFallback{page}{Pagina}
    \NewTranslation{english}{page}{Page}

    % These need to be defined outside of cfoot, otherwise GetTranslation is expanded too early.
    \newcommand*{\foot@title}{\GetTranslation{title}}
    \newcommand*{\foot@date}{\GetTranslation{date}}
    \newcommand*{\foot@page}{\GetTranslation{page}}

    % If enabled, add the footer. This is only enabled by default when using style=notes,
    % but can be overridden.
    \IfEq{\@showfooter}{1}{
        \RequirePackage{lastpage} % Only needed if we use this

        \setkomafont{pagefoot}{\normalfont} % No italics please
        \setkomafont{pagenumber}{} % Nothing please
        \ifoot*{} % Empty the inner footer.
        \cfoot*{
            \begin{tikzpicture}[remember picture,overlay,every node/.style={inner sep=0,outer sep=0}]
                \node[anchor=north west] (footer) at ([shift={(1.5\smallblock,2.4\smallblock)}]current page.south west) {
                    \includegraphics[height=2\smallblock]{\@campusname}
                };
                \node[anchor=north west, align=left] (title) at ([shift={(5\smallblock,2\smallblock)}]current page.south west) {
                    \begin{minipage}[c][1\smallblock][s]{7\smallblock}
                        \raggedright
                        \pannosemibold[8pt][10pt]{\color{ugent-blue}\MakeTextUppercase{\foot@title}} \\
                        \panno[10pt][15pt]{\@title}
                    \end{minipage}
                };
                \node[anchor=north west, align=left] (title) at ([shift={(14\smallblock,2\smallblock)}]current page.south west) {
                    \begin{minipage}[c][1\smallblock][s]{2\smallblock}
                        \raggedright
                        \pannosemibold[8pt][10pt]{\color{ugent-blue}\MakeTextUppercase{\foot@date}} \\
                        \panno[10pt][15pt]{\@date}
                    \end{minipage}
                };
                \node[anchor=north west, align=left] (title) at ([shift={(17\smallblock,2\smallblock)}]current page.south west) {
                    \begin{minipage}[c][1\smallblock][s]{1\smallblock}
                        \raggedright
                        \pannosemibold[8pt][10pt]{\color{ugent-blue}\MakeTextUppercase{\foot@page}} \\
                        \panno[10pt][15pt]{\pagemark/\pageref*{LastPage}}
                    \end{minipage}
                };
            \end{tikzpicture}
        }
        \ofoot*{} % Empty the outer footer.
    }{}
}
